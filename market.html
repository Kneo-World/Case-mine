<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Case-Mine | Онлайн Рынок</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --tg-bg: #0b0e14; --accent: #007aff; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Inter', sans-serif; background: var(--tg-bg); color: white; margin: 0; }
        .glass { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; }
        .page { padding: 20px; padding-bottom: 100px; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <header class="sticky top-0 z-50 bg-[#0b0e14]/80 backdrop-blur-md p-4 flex justify-between items-center border-b border-white/5">
        <div class="glass px-3 py-1 flex items-center gap-2">
            <span class="text-yellow-400">⭐</span>
            <span id="market-balance" class="font-bold text-sm">0</span>
        </div>
        <div class="text-xs font-bold text-blue-400">ONLINE MARKET</div>
    </header>

    <main class="page">
        <div class="mb-6">
            <h2 class="text-xl font-bold">Вещи других игроков</h2>
            <p class="text-[10px] opacity-50">Обновляется в реальном времени</p>
        </div>

        <div id="online-grid" class="grid grid-cols-2 gap-3">
            <div class="col-span-2 text-center py-10 opacity-50 text-xs">Загрузка товаров...</div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-20 glass rounded-none border-t border-white/5 flex justify-around items-center z-50">
        <button onclick="window.location.href='index.html'" class="flex flex-col items-center gap-1 opacity-50">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold">КЕЙСЫ</span>
        </button>
        <button class="flex flex-col items-center gap-1 text-blue-500">
            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold">МАРКЕТ</span>
        </button>
    </nav>

    <script type="module">
        // Импорт Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Твой конфиг
        const firebaseConfig = {
            apiKey: "AIzaSyDnmAysvjn6Zu-pbddOhXDt1ohnZaY1Fcw",
            authDomain: "casemine-online.firebaseapp.com",
            projectId: "casemine-online",
            storageBucket: "casemine-online.firebasestorage.app",
            messagingSenderId: "750443799326",
            appId: "1:750443799326:web:edec309f732337e39a1f0f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const marketRef = ref(db, 'online_market');
        const tg = window.Telegram.WebApp;

        // Данные из localStorage (синхрон с кейсами)
        const SHARED_KEY = 'casemine_inventory';
        const BALANCE_KEY = 'balance';

        let balance = parseFloat(localStorage.getItem(BALANCE_KEY)) || 0;
        let inventory = JSON.parse(localStorage.getItem(SHARED_KEY)) || [];

        function updateHeader() {
            document.getElementById('market-balance').innerText = balance.toFixed(0);
            localStorage.setItem(BALANCE_KEY, balance);
            localStorage.setItem(SHARED_KEY, JSON.stringify(inventory));
        }

        // Покупка товара
        window.buyItem = function(key, price, name, emoji) {
            if (balance < price) {
                tg.showAlert("Недостаточно звезд для покупки!");
                return;
            }

            tg.showConfirm(`Купить ${name} за ${price} ⭐?`, (ok) => {
                if (ok) {
                    const itemRef = ref(db, 'online_market/' + key);
                    
                    // Удаляем из базы (бронируем покупку)
                    remove(itemRef).then(() => {
                        balance -= price;
                        inventory.push({ name, emoji, value: price });
                        updateHeader();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("Куплено! Предмет добавлен в ваш профиль.");
                    }).catch(() => {
                        tg.showAlert("Ошибка: товар уже купил кто-то другой!");
                    });
                }
            });
        };

        // Слушатель базы данных
        onValue(marketRef, (snapshot) => {
            const data = snapshot.val();
            const grid = document.getElementById('online-grid');
            grid.innerHTML = "";

            if (!data) {
                grid.innerHTML = "<p class='col-span-2 text-center opacity-50 py-10'>На рынке пока нет товаров</p>";
                return;
            }

            Object.keys(data).forEach(key => {
                const item = data[key];
                const isMine = item.sellerId == tg.initDataUnsafe?.user?.id;

                grid.innerHTML += `
                    <div class="glass p-4 flex flex-col items-center text-center relative">
                        <span class="text-4xl mb-2">${item.emoji}</span>
                        <div class="text-[10px] font-bold mb-1">${item.name}</div>
                        <div class="text-[8px] opacity-40 mb-3 text-blue-300 uppercase">Продавец: ${item.seller}</div>
                        
                        <button onclick="buyItem('${key}', ${item.value}, '${item.name}', '${item.emoji}')" 
                                class="${isMine ? 'bg-white/10 opacity-50' : 'bg-blue-600 active:scale-95'} w-full py-2 rounded-xl text-[10px] font-bold transition-all"
                                ${isMine ? 'disabled' : ''}>
                            ${isMine ? 'ТВОЙ ТОВАР' : 'КУПИТЬ ' + item.value + ' ⭐'}
                        </button>
                    </div>
                `;
            });
        });

        // Инициализация
        lucide.createIcons();
        updateHeader();
        tg.expand();

    </script>
</body>
</html>
