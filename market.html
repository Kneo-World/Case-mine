<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Case-Mine | Market</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --tg-bg: #0b0e14; --accent: #007aff; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Inter', sans-serif; background: var(--tg-bg); color: white; margin: 0; }
        .glass { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; }
        .nav-item.active { color: var(--accent); opacity: 1; }
        ::-webkit-scrollbar { display: none; }
        .page { display: none; padding: 20px; padding-bottom: 100px; }
        .page.active { display: block; }
    </style>
</head>
<body>

    <header class="sticky top-0 z-50 bg-[#0b0e14]/80 backdrop-blur-md p-4 flex justify-between items-center">
        <div class="flex gap-2">
            <div class="glass px-3 py-1 flex items-center gap-2">
                <span class="text-yellow-400">‚≠ê</span>
                <span id="star-balance" class="font-bold text-sm">0</span>
            </div>
        </div>
        <div class="text-xs font-bold text-blue-400">MARKETPLACE</div>
    </header>

    <section id="page-market" class="page active">
        <h2 class="text-xl font-bold mb-4">–ñ–∏–≤–æ–π —Ä—ã–Ω–æ–∫ üåç</h2>
        <div id="online-market-grid" class="grid grid-cols-2 gap-3">
            </div>
    </section>

    <section id="page-inventory" class="page">
        <h2 class="text-xl font-bold mb-4">–ú–æ–∏ –ø–æ–¥–∞—Ä–∫–∏</h2>
        <div id="my-inventory-grid" class="grid grid-cols-2 gap-3">
            </div>
    </section>

    <nav class="fixed bottom-0 left-0 right-0 h-20 glass rounded-none border-t border-white/5 flex justify-around items-center z-50">
        <button onclick="showPage('market')" id="nav-market" class="nav-item active flex flex-col items-center gap-1">
            <i data-lucide="globe" class="w-5 h-5"></i><span class="text-[10px] font-bold">–†–´–ù–û–ö</span>
        </button>
        <button onclick="showPage('inventory')" id="nav-inventory" class="nav-item opacity-50 flex flex-col items-center gap-1">
            <i data-lucide="package" class="w-5 h-5"></i><span class="text-[10px] font-bold">–ú–û–ò –í–ï–©–ò</span>
        </button>
        <button onclick="window.location.href='index.html'" class="nav-item opacity-50 flex flex-col items-center gap-1">
            <i data-lucide="arrow-left" class="w-5 h-5"></i><span class="text-[10px] font-bold">–ö–ï–ô–°–´</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // –ö–û–ù–§–ò–ì –ò–ó –¢–í–û–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø
        const firebaseConfig = {
            apiKey: "AIzaSyDnmAysvjn6Zu-pbddOhXDt1ohnZaY1Fcw",
            authDomain: "casemine-online.firebaseapp.com",
            projectId: "casemine-online",
            storageBucket: "casemine-online.firebasestorage.app",
            messagingSenderId: "750443799326",
            appId: "1:750443799326:web:edec309f732337e39a1f0f",
            measurementId: "G-53DGVYVD33"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const marketRef = ref(db, 'online_market');
        const tg = window.Telegram.WebApp;

        const SHARED_KEY = 'casemine_inventory';
        const BALANCE_KEY = 'balance';

        let myInventory = JSON.parse(localStorage.getItem(SHARED_KEY)) || [];
        let myStars = parseFloat(localStorage.getItem(BALANCE_KEY)) || 0;

        function init() {
            lucide.createIcons();
            updateUI();
            tg.expand();
        }

        function updateUI() {
            document.getElementById('star-balance').innerText = myStars.toFixed(0);
            localStorage.setItem(SHARED_KEY, JSON.stringify(myInventory));
            localStorage.setItem(BALANCE_KEY, myStars);
            renderMyInventory();
        }

        // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏—á–Ω–æ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        window.renderMyInventory = function() {
            const grid = document.getElementById('my-inventory-grid');
            if (myInventory.length === 0) {
                grid.innerHTML = "<p class='col-span-2 text-center opacity-50 py-10'>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>";
                return;
            }
            grid.innerHTML = myInventory.map((item, idx) => `
                <div class="glass p-4 flex flex-col items-center text-center">
                    <span class="text-4xl mb-2">${item.emoji}</span>
                    <span class="text-[10px] font-bold mb-3">${item.name}</span>
                    <div class="flex flex-col gap-2 w-full">
                        <button onclick="fastSell(${idx})" class="bg-red-500/20 text-red-400 text-[8px] font-bold py-2 rounded">–§–ê–°–¢ –ü–†–û–î–ê–ñ–ê (-10%)</button>
                        <button onclick="listToOnlineMarket(${idx})" class="bg-blue-600 text-white text-[8px] font-bold py-2 rounded">–í–´–°–¢–ê–í–ò–¢–¨ –ù–ê –†–´–ù–û–ö</button>
                    </div>
                </div>
            `).join('');
        };

        // 2. –ë–´–°–¢–†–ê–Ø –ü–†–û–î–ê–ñ–ê (-10%)
        window.fastSell = function(idx) {
            const item = myInventory[idx];
            const price = item.value * 0.9; // –ó–∞–±–∏—Ä–∞–µ–º 10%
            tg.showConfirm(`–ü—Ä–æ–¥–∞—Ç—å ${item.name} –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –∑–∞ ${price.toFixed(0)} ‚≠ê?`, (ok) => {
                if(ok) {
                    myStars += price;
                    myInventory.splice(idx, 1);
                    tg.HapticFeedback.notificationOccurred('success');
                    updateUI();
                }
            });
        };

        // 3. –í–´–°–¢–ê–í–ò–¢–¨ –ù–ê –û–ù–õ–ê–ô–ù –†–´–ù–û–ö
        window.listToOnlineMarket = function(idx) {
            const item = myInventory[idx];
            const sellerName = tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
            
            push(marketRef, {
                ...item,
                seller: sellerName,
                sellerId: tg.initDataUnsafe?.user?.id || "0",
                listTime: Date.now()
            }).then(() => {
                myInventory.splice(idx, 1);
                updateUI();
                tg.showAlert("–ü—Ä–µ–¥–º–µ—Ç —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç –≤—Å–µ!");
            });
        };

        // 4. –ü–û–ö–£–ü–ö–ê –£ –î–†–£–ì–ò–• –ò–ì–†–û–ö–û–í
        window.buyItem = function(key, price, name, emoji) {
            if (myStars < price) {
                tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!");
                return;
            }
            tg.showConfirm(`–ö—É–ø–∏—Ç—å ${name} –∑–∞ ${price} ‚≠ê?`, (ok) => {
                if(ok) {
                    const itemRef = ref(db, 'online_market/' + key);
                    remove(itemRef).then(() => {
                        myStars -= price;
                        myInventory.unshift({ name, emoji, value: price });
                        updateUI();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("–ö—É–ø–ª–µ–Ω–æ! –ü—Ä–µ–¥–º–µ—Ç –≤ –≤–∞—à–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ.");
                    }).catch(() => {
                        tg.showAlert("–ü–æ—Ö–æ–∂–µ, —Ç–æ–≤–∞—Ä —É–∂–µ –∫—Ç–æ-—Ç–æ –∫—É–ø–∏–ª!");
                    });
                }
            });
        };

        // 5. –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• –° –†–´–ù–ö–ê (–û–ù–õ–ê–ô–ù)
        onValue(marketRef, (snapshot) => {
            const data = snapshot.val();
            const grid = document.getElementById('online-market-grid');
            grid.innerHTML = "";
            if (!data) {
                grid.innerHTML = "<p class='col-span-2 text-center opacity-50 py-10'>–ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>";
                return;
            }
            Object.keys(data).forEach(key => {
                const item = data[key];
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–∏ –∂–µ —Ç–æ–≤–∞—Ä—ã –≤ —Å–ø–∏—Å–∫–µ –ø–æ–∫—É–ø–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                const isMine = item.sellerId == tg.initDataUnsafe?.user?.id;
                
                grid.innerHTML += `
                    <div class="glass p-4 flex flex-col items-center text-center relative">
                        ${isMine ? '<span class="absolute top-2 right-2 text-[7px] bg-blue-500 px-1 rounded">–í–ê–®</span>' : ''}
                        <span class="text-4xl mb-2">${item.emoji}</span>
                        <span class="text-[10px] font-bold">${item.name}</span>
                        <p class="text-[7px] opacity-50 mt-1">–ü—Ä–æ–¥–∞–≤–µ—Ü: ${item.seller}</p>
                        <button onclick="buyItem('${key}', ${item.value}, '${item.name}', '${item.emoji}')" 
                                ${isMine ? 'disabled class="mt-3 w-full bg-white/10 opacity-50 text-[9px] py-2 rounded"' : 'class="mt-3 w-full bg-blue-600 text-[9px] py-2 rounded"'} >
                            –ö–£–ü–ò–¢–¨ ${item.value} ‚≠ê
                        </button>
                    </div>
                `;
            });
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
        window.showPage = function(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.add('opacity-50', 'active')); // —Å–±—Ä–æ—Å
            document.getElementById('page-' + p).classList.add('active');
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–æ–∫—É—Å –Ω–∞ –∏–∫–æ–Ω–∫—É
            document.querySelectorAll('.nav-item').forEach(el => el.classList.add('opacity-50'));
            document.getElementById('nav-' + p).classList.remove('opacity-50');
            
            if(p === 'inventory') renderMyInventory();
            tg.HapticFeedback.impactOccurred('light');
        };

        window.init = init;
        init();

    </script>
</body>
</html>
