<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Case-Mine | –û–Ω–ª–∞–π–Ω –†—ã–Ω–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --tg-bg: #0b0e14; --accent: #007aff; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Inter', sans-serif; background: var(--tg-bg); color: white; margin: 0; }
        .glass { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); border-radius: 18px; }
        .page { padding: 20px; padding-bottom: 100px; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <header class="sticky top-0 z-50 bg-[#0b0e14]/80 backdrop-blur-md p-4 flex justify-between items-center border-b border-white/5">
        <div class="glass px-3 py-1 flex items-center gap-2">
            <span class="text-yellow-400">‚≠ê</span>
            <span id="market-balance" class="font-bold text-sm">0</span>
        </div>
        <div class="text-xs font-bold text-blue-400 uppercase">–û–Ω–ª–∞–π–Ω –ú–∞—Ä–∫–µ—Ç</div>
    </header>

    <main class="page">
        <div class="mb-6 text-center">
            <h2 class="text-xl font-bold italic text-blue-400">–í–ò–¢–†–ò–ù–ê –¢–û–í–ê–†–û–í</h2>
            <p class="text-[9px] opacity-40 uppercase tracking-widest mt-1">–ó–¥–µ—Å—å –≤–µ—â–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ Case-Mine</p>
        </div>

        <div id="online-grid" class="grid grid-cols-2 gap-3">
            <div class="col-span-2 text-center py-10 opacity-30 text-xs uppercase tracking-tighter">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 h-20 glass rounded-none border-t border-white/5 flex justify-around items-center z-50">
        <button onclick="window.location.href='index.html'" class="flex flex-col items-center gap-1 opacity-50">
            <i data-lucide="package" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold">–ö–ï–ô–°–´</span>
        </button>
        <button class="flex flex-col items-center gap-1 text-blue-500">
            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
            <span class="text-[10px] font-bold">–ú–ê–†–ö–ï–¢</span>
        </button>
    </nav>

    <script>
        // –¢–æ—Ç –∂–µ –∫–æ–Ω—Ñ–∏–≥, —á—Ç–æ –∏ –≤ index.html
        const firebaseConfig = {
            apiKey: "AIzaSyDnmAysvjn6Zu-pbddOhXDt1ohnZaY1Fcw",
            authDomain: "casemine-online.firebaseapp.com",
            projectId: "casemine-online",
            storageBucket: "casemine-online.firebasestorage.app",
            messagingSenderId: "750443799326",
            appId: "1:750443799326:web:edec309f732337e39a1f0f"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;

        const SHARED_KEY = 'casemine_inventory';
        const BALANCE_KEY = 'balance';

        let balance = parseFloat(localStorage.getItem(BALANCE_KEY)) || 0;
        let inventory = JSON.parse(localStorage.getItem(SHARED_KEY)) || [];

        function saveAndRefresh() {
            document.getElementById('market-balance').innerText = balance.toFixed(0);
            localStorage.setItem(BALANCE_KEY, balance);
            localStorage.setItem(SHARED_KEY, JSON.stringify(inventory));
        }

        // –ü–û–ö–£–ü–ö–ê –¢–û–í–ê–†–ê
        function buyItem(key, price, name, emoji) {
            if (balance < price) {
                tg.showAlert("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚≠ê –∑–≤–µ–∑–¥!");
                return;
            }

            tg.showConfirm(`–ö—É–ø–∏—Ç—å ${name} –∑–∞ ${price} ‚≠ê?`, (ok) => {
                if (ok) {
                    const itemRef = db.ref('online_market/' + key);
                    
                    // –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã (–µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –Ω–µ –∫—É–ø–∏–ª —Ä–∞–Ω—å—à–µ)
                    itemRef.remove().then(() => {
                        balance -= price;
                        inventory.push({ name, emoji, value: price });
                        saveAndRefresh();
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert("üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü—Ä–µ–¥–º–µ—Ç —Ç–µ–ø–µ—Ä—å —É –≤–∞—Å.");
                    }).catch(() => {
                        tg.showAlert("–û—à–∏–±–∫–∞: —Ç–æ–≤–∞—Ä —É–∂–µ –ø—Ä–æ–¥–∞–Ω –∏–ª–∏ —Å–Ω—è—Ç —Å –ø—Ä–æ–¥–∞–∂–∏.");
                    });
                }
            });
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ü–ò–°–ö–ê –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò
        db.ref('online_market').on('value', (snapshot) => {
            const data = snapshot.val();
            const grid = document.getElementById('online-grid');
            grid.innerHTML = "";

            if (!data) {
                grid.innerHTML = "<p class='col-span-2 text-center opacity-30 py-10 uppercase text-xs'>–†—ã–Ω–æ–∫ –ø—É—Å—Ç</p>";
                return;
            }

            Object.keys(data).forEach(key => {
                const item = data[key];
                const isMine = item.sellerId == (tg.initDataUnsafe?.user?.id || "0");

                grid.innerHTML += `
                    <div class="glass p-4 flex flex-col items-center text-center">
                        <span class="text-4xl mb-2">${item.emoji}</span>
                        <div class="text-[10px] font-bold mb-1">${item.name}</div>
                        <div class="text-[8px] opacity-40 mb-3 text-blue-300 uppercase italic">–ü—Ä–æ–¥–∞–≤–µ—Ü: ${item.seller}</div>
                        
                        <button onclick="buyItem('${key}', ${item.value}, '${item.name}', '${item.emoji}')" 
                                class="${isMine ? 'bg-white/10 opacity-30 cursor-not-allowed' : 'bg-blue-600 active:scale-95'} w-full py-2 rounded-xl text-[10px] font-bold transition-all"
                                ${isMine ? 'disabled' : ''}>
                            ${isMine ? '–í–ê–® –õ–û–¢' : '–ö–£–ü–ò–¢–¨ –ó–ê ' + item.value + ' ‚≠ê'}
                        </button>
                    </div>
                `;
            });
        });

        lucide.createIcons();
        saveAndRefresh();
        tg.expand();
    </script>
</body>
</html>
