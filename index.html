<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Case-Mine | Opener</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --tg-bg: #0f1218; --accent: #007aff; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Inter', sans-serif; background: var(--tg-bg); color: white; margin: 0; overflow: hidden; }
        .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        
        /* Snow Effect */
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.3; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }

        /* Roulette Engine */
        .roulette-wrapper { position: relative; width: 100%; height: 120px; overflow: hidden; border-radius: 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .roulette-container { display: flex; position: absolute; left: 0; transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); }
        .roulette-item { min-width: 100px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid rgba(255,255,255,0.05); }
        .roulette-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2px; height: 100%; background: var(--accent); z-index: 10; box-shadow: 0 0 15px var(--accent); }

        .premium-border { border: 2px solid #facc15 !important; box-shadow: 0 0 15px rgba(250, 204, 21, 0.3); }
        .page { display: none; height: calc(100vh - 80px); overflow-y: auto; padding: 20px; position: relative; z-index: 1; }
        .page.active { display: block; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="snow" class="fixed inset-0 pointer-events-none"></div>

    <header class="flex justify-between items-center p-4 relative z-10">
        <div class="glass px-3 py-1 flex items-center gap-2">
            <span class="text-yellow-400 text-sm">‚≠ê</span>
            <span id="header-balance" class="font-bold text-sm">0.00</span>
        </div>
        <div class="w-8 h-8 rounded-full border border-blue-500 overflow-hidden" id="user-pfp-container">
            <img src="" id="user-pfp" class="w-full h-full hidden">
        </div>
    </header>

    <main>
        <section id="page-cases" class="page active">
            <h2 class="text-2xl font-bold mb-4">Open Cases</h2>
            <div class="grid grid-cols-2 gap-4" id="cases-grid"></div>
        </section>

        <section id="page-profile" class="page">
            <div class="glass p-6 mb-4 flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl bg-blue-600 flex items-center justify-center text-2xl font-bold" id="profile-initial">?</div>
                <div>
                    <h3 id="profile-name" class="text-xl font-bold">Player</h3>
                    <p class="text-xs text-blue-400" id="inv-stats">0 Items in Inventory</p>
                </div>
            </div>
            <button onclick="window.location.href='https://kneo-world.github.io/Case-mine-market/'" class="w-full glass py-4 mb-6 flex items-center justify-center gap-2 font-bold text-sm text-yellow-500">
                <i data-lucide="shopping-cart" class="w-4 h-4"></i> OPEN MARKETPLACE
            </button>
            <div id="inventory-grid" class="grid grid-cols-3 gap-2"></div>
        </section>
    </main>

    <div id="case-modal" class="fixed inset-0 z-50 flex items-end justify-center hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="glass w-full max-w-md p-6 rounded-t-[30px] z-10 translate-y-full transition-transform duration-300" id="modal-content">
            <div class="w-12 h-1 bg-white/20 rounded-full mx-auto mb-6"></div>
            <h2 id="modal-title" class="text-2xl font-bold text-center mb-1">Case</h2>
            <p id="modal-price" class="text-center text-blue-400 mb-6 font-bold"></p>

            <div id="roulette-view" class="hidden">
                <div class="roulette-wrapper mb-6">
                    <div class="roulette-pointer"></div>
                    <div class="roulette-container" id="roulette-strip"></div>
                </div>
            </div>

            <div id="droplist-view">
                <p class="text-[10px] opacity-40 uppercase font-bold mb-3 tracking-widest text-center">Possible Drops & Odds</p>
                <div class="grid grid-cols-4 gap-2 mb-8" id="drop-list-items"></div>
            </div>

            <button id="open-btn" onclick="startOpening()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold text-lg">Open Case</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 glass rounded-none border-t border-white/5 flex justify-around items-center px-4 z-20">
        <button onclick="showPage('cases')" id="nav-cases" class="flex flex-col items-center gap-1 text-blue-500">
            <i data-lucide="box"></i><span class="text-[10px] font-bold">CASES</span>
        </button>
        <button onclick="showPage('profile')" id="nav-profile" class="flex flex-col items-center gap-1 opacity-50">
            <i data-lucide="user"></i><span class="text-[10px] font-bold">PROFILE</span>
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const SHARED_KEY = 'casemine_inventory';
        const BALANCE_KEY = 'balance';

        // 1. DATA (Keep this consistent with Market)
        const ITEMS = {
            S1: { name: '1 Star', emoji: '‚≠ê', value: 1, rarity: 'common' },
            S5: { name: '5 Stars', emoji: '‚≠ê', value: 5, rarity: 'common' },
            BEAR: { name: 'Bear Gift', emoji: 'üß∏', value: 15, rarity: 'rare' },
            CAKE: { name: 'Cake Gift', emoji: 'üéÇ', value: 50, rarity: 'legendary' },
            ROCKET: { name: 'Rocket Gift', emoji: 'üöÄ', value: 100, rarity: 'legendary' },
            CANDLE: { name: 'B-Day Candle', emoji: 'üïØÔ∏è', value: 500, rarity: 'nft', nft: true },
            MONKEY: { name: 'Gold Monkey', emoji: 'üêí', value: 800, rarity: 'nft', nft: true }
        };

        const CASES = [
            { id: 'free', name: 'Free', price: 0, color: 'from-green-500', loot: [{item: ITEMS.S1, chance: 90}, {item: ITEMS.BEAR, chance: 10}] },
            { id: 'bum', name: 'Bum', price: 25, color: 'from-orange-500', loot: [{item: ITEMS.S5, chance: 70}, {item: ITEMS.BEAR, chance: 30}] },
            { id: 'rocket', name: 'Rocket', price: 100, color: 'from-purple-500', loot: [{item: ITEMS.CAKE, chance: 70}, {item: ITEMS.ROCKET, chance: 29.9}, {item: ITEMS.CANDLE, chance: 0.1}] },
            { id: 'world', name: 'World', price: 500, color: 'from-yellow-500', loot: [{item: ITEMS.CANDLE, chance: 95}, {item: ITEMS.MONKEY, chance: 5}] }
        ];

        let balance = parseFloat(localStorage.getItem(BALANCE_KEY)) || 100.00;
        let inventory = JSON.parse(localStorage.getItem(SHARED_KEY)) || [];
        let activeCase = null;
        let isSpinning = false;

        // 2. CORE SYNC LOGIC
        function syncWinToMarket(winnerItem) {
            inventory.unshift({
                ...winnerItem,
                id: Date.now(),
                owner: tg.initDataUnsafe?.user?.id || 'local'
            });
            localStorage.setItem(SHARED_KEY, JSON.stringify(inventory));
            localStorage.setItem(BALANCE_KEY, balance);
            updateUI();
        }

        // 3. UI ENGINE
        function init() {
            lucide.createIcons();
            renderCases();
            updateUI();
            createSnow();
            
            const user = tg.initDataUnsafe?.user;
            if (user) {
                document.getElementById('profile-name').innerText = user.first_name;
                document.getElementById('profile-initial').innerText = user.first_name[0];
                if(user.photo_url) {
                    const img = document.getElementById('user-pfp');
                    img.src = user.photo_url;
                    img.classList.remove('hidden');
                }
            }
            tg.expand();
        }

        function updateUI() {
            document.getElementById('header-balance').innerText = balance.toFixed(2);
            document.getElementById('inv-stats').innerText = `${inventory.length} Items in Inventory`;
            
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = inventory.map(item => `
                <div class="glass p-2 flex flex-col items-center justify-center aspect-square text-center ${item.nft ? 'premium-border' : ''}">
                    <span class="text-2xl">${item.emoji}</span>
                    <span class="text-[8px] opacity-50 truncate w-full mt-1">${item.name}</span>
                </div>
            `).join('');
        }

        function renderCases() {
            const grid = document.getElementById('cases-grid');
            CASES.forEach(c => {
                const el = document.createElement('div');
                el.className = `glass bg-gradient-to-br ${c.color}/10 p-5 flex flex-col items-center gap-3 active:scale-95 transition-transform cursor-pointer`;
                el.onclick = () => openCaseModal(c);
                el.innerHTML = `<div class="text-4xl">üì¶</div><div><p class="font-bold text-sm">${c.name}</p><p class="text-xs text-blue-400 font-bold">${c.price === 0 ? 'FREE' : c.price + ' ‚≠ê'}</p></div>`;
                grid.appendChild(el);
            });
        }

        function openCaseModal(c) {
            activeCase = c;
            document.getElementById('modal-title').innerText = c.name + " Case";
            document.getElementById('modal-price').innerText = c.price === 0 ? "Daily Claim" : c.price + " ‚≠ê";
            
            const list = document.getElementById('drop-list-items');
            list.innerHTML = c.loot.map(l => `
                <div class="glass p-2 flex flex-col items-center relative overflow-hidden">
                    <span class="text-[8px] absolute top-1 right-1 font-bold text-blue-400">${l.chance}%</span>
                    <span class="text-xl">${l.item.emoji}</span>
                </div>
            `).join('');

            document.getElementById('case-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-content').style.transform = 'translateY(0)', 10);
            document.getElementById('roulette-view').classList.add('hidden');
            document.getElementById('droplist-view').classList.remove('hidden');
            document.getElementById('open-btn').style.display = 'block';
        }

        // 4. SPIN LOGIC
        function startOpening() {
            if (balance < activeCase.price) return tg.showAlert("Insufficient Stars");
            isSpinning = true;
            balance -= activeCase.price;
            updateUI();

            document.getElementById('droplist-view').classList.add('hidden');
            document.getElementById('open-btn').style.display = 'none';
            document.getElementById('roulette-view').classList.remove('hidden');

            // Weighted Math
            const rand = Math.random() * 100;
            let cumulative = 0;
            let winner = activeCase.loot[0].item;
            for(let l of activeCase.loot) {
                cumulative += l.chance;
                if(rand <= cumulative) { winner = l.item; break; }
            }

            const strip = document.getElementById('roulette-strip');
            strip.style.transition = 'none';
            strip.style.transform = 'translateX(0)';

            let stripHTML = '';
            for(let i=0; i<60; i++) {
                const r = activeCase.loot[Math.floor(Math.random()*activeCase.loot.length)].item;
                stripHTML += `<div class="roulette-item"><span class="text-3xl">${r.emoji}</span></div>`;
            }
            strip.innerHTML = stripHTML;
            const winIdx = 55;
            strip.children[winIdx].innerHTML = `<span class="text-3xl">${winner.emoji}</span>`;
            if(winner.nft) strip.children[winIdx].classList.add('premium-border');

            setTimeout(() => {
                const targetX = (winIdx * 100) - (document.querySelector('.roulette-wrapper').offsetWidth / 2) + 50;
                strip.style.transition = 'transform 5s cubic-bezier(0.1, 0, 0.1, 1)';
                strip.style.transform = `translateX(-${targetX}px)`;
            }, 50);

            setTimeout(() => {
                if(winner.name.includes('Star')) balance += winner.value;
                syncWinToMarket(winner);
                isSpinning = false;
                tg.HapticFeedback.notificationOccurred('success');
                tg.showConfirm(`Won: ${winner.name}`, () => closeModal());
            }, 5500);
        }

        function closeModal() { if(!isSpinning) { document.getElementById('modal-content').style.transform = 'translateY(100%)'; setTimeout(() => document.getElementById('case-modal').classList.add('hidden'), 300); } }
        
        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-50'));
            document.getElementById(`nav-${p}`).classList.remove('opacity-50');
            tg.HapticFeedback.impactOccurred('light');
        }

        function createSnow() {
            const container = document.getElementById('snow');
            for(let i=0; i<20; i++) {
                const f = document.createElement('div');
                f.className = 'snowflake';
                f.style.left = Math.random() * 100 + 'vw';
                f.style.width = f.style.height = (Math.random()*3+2)+'px';
                f.style.animationDuration = (Math.random()*3+5)+'s';
                container.appendChild(f);
            }
        }

        // Listen for Marketplace Sells (Balance Updates)
        window.addEventListener('storage', (e) => {
            if(e.key === BALANCE_KEY || e.key === SHARED_KEY) {
                balance = parseFloat(localStorage.getItem(BALANCE_KEY));
                inventory = JSON.parse(localStorage.getItem(SHARED_KEY));
                updateUI();
            }
        });

        window.onload = init;
    </script>
</body>
</html>
