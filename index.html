<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Case-Mine | –ö–µ–π—Å—ã</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        :root { --tg-bg: #0f1218; --accent: #007aff; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Inter', sans-serif; background: var(--tg-bg); color: white; margin: 0; overflow: hidden; }
        .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        
        .roulette-wrapper { position: relative; width: 100%; height: 120px; overflow: hidden; border-radius: 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .roulette-container { display: flex; position: absolute; left: 0; transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); }
        .roulette-item { min-width: 100px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .roulette-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2px; height: 100%; background: var(--accent); z-index: 10; box-shadow: 0 0 15px var(--accent); }

        .page { display: none; height: calc(100vh - 80px); overflow-y: auto; padding: 20px; }
        .page.active { display: block; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <header class="flex justify-between items-center p-4 relative z-10">
        <div class="glass px-3 py-1 flex items-center gap-2">
            <span class="text-yellow-400 text-sm">‚≠ê</span>
            <span id="header-balance" class="font-bold text-sm">0</span>
        </div>
        <div class="text-xs font-bold text-blue-500 uppercase">Case Opener</div>
    </header>

    <main>
        <section id="page-cases" class="page active">
            <h2 class="text-2xl font-bold mb-4">–ú–∞–≥–∞–∑–∏–Ω –∫–µ–π—Å–æ–≤</h2>
            <div class="grid grid-cols-2 gap-4" id="cases-grid"></div>
        </section>
    </main>

    <div id="case-modal" class="fixed inset-0 z-50 flex items-end justify-center hidden">
        <div class="absolute inset-0 bg-black/80" onclick="closeModal()"></div>
        <div class="glass w-full max-w-md p-6 rounded-t-[30px] z-10 translate-y-full transition-transform duration-300" id="modal-content">
            <div class="w-12 h-1 bg-white/20 rounded-full mx-auto mb-6"></div>
            <h2 id="modal-title" class="text-2xl font-bold text-center mb-1">–ö–µ–π—Å</h2>
            <p id="modal-price" class="text-center text-blue-400 mb-6 font-bold"></p>

            <div id="roulette-view" class="hidden">
                <div class="roulette-wrapper mb-6">
                    <div class="roulette-pointer"></div>
                    <div class="roulette-container" id="roulette-strip"></div>
                </div>
            </div>

            <div id="droplist-view">
                <p class="text-[10px] opacity-40 uppercase font-bold mb-3 text-center">–í–æ–∑–º–æ–∂–Ω—ã–π –¥—Ä–æ–ø</p>
                <div class="grid grid-cols-4 gap-2 mb-8" id="drop-list-items"></div>
            </div>

            <button id="open-btn" onclick="startOpening()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold text-lg active:scale-95 transition-all">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 glass rounded-none border-t border-white/5 flex justify-around items-center z-20">
        <button class="flex flex-col items-center gap-1 text-blue-500">
            <i data-lucide="package"></i><span class="text-[10px] font-bold">–ö–ï–ô–°–´</span>
        </button>
        <button onclick="window.location.href='market.html'" class="flex flex-col items-center gap-1 opacity-50">
            <i data-lucide="shopping-cart"></i><span class="text-[10px] font-bold">–ú–ê–†–ö–ï–¢</span>
        </button>
    </nav>

    <script>
        const tg = window.Telegram.WebApp;
        const SHARED_KEY = 'casemine_inventory';
        const BALANCE_KEY = 'balance';

        const ITEMS = {
            S5: { name: '5 –ó–≤–µ–∑–¥', emoji: '‚≠ê', value: 5 },
            BEAR: { name: '–ú–∏—à–∫–∞', emoji: 'üß∏', value: 15 },
            CAKE: { name: '–¢–æ—Ä—Ç', emoji: 'üéÇ', value: 50 },
            ROCKET: { name: '–†–∞–∫–µ—Ç–∞', emoji: 'üöÄ', value: 100 },
            CANDLE: { name: '–°–≤–µ—á–∞', emoji: 'üïØÔ∏è', value: 500 }
        };

        const CASES = [
            { id: 'free', name: '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π', price: 0, color: 'from-green-500', loot: [{item: ITEMS.S5, chance: 80}, {item: ITEMS.BEAR, chance: 20}] },
            { id: 'normal', name: '–û–±—ã—á–Ω—ã–π', price: 50, color: 'from-blue-500', loot: [{item: ITEMS.BEAR, chance: 70}, {item: ITEMS.CAKE, chance: 30}] },
            { id: 'pro', name: '–≠–ª–∏—Ç–Ω—ã–π', price: 150, color: 'from-purple-500', loot: [{item: ITEMS.CAKE, chance: 60}, {item: ITEMS.ROCKET, chance: 40}] }
        ];

        let balance = parseFloat(localStorage.getItem(BALANCE_KEY)) || 100;
        let inventory = JSON.parse(localStorage.getItem(SHARED_KEY)) || [];
        let activeCase = null;
        let isSpinning = false;

        function init() {
            lucide.createIcons();
            renderCases();
            updateUI();
            tg.expand();
            
            // –ú–∞–≥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: —Å–ª–µ–¥–∏–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö –≤–∫–ª–∞–¥–æ–∫ (–º–∞—Ä–∫–µ—Ç–∞)
            window.addEventListener('storage', (e) => {
                if (e.key === BALANCE_KEY) {
                    balance = parseFloat(e.newValue);
                    document.getElementById('header-balance').innerText = balance.toFixed(0);
                }
                if (e.key === SHARED_KEY) {
                    inventory = JSON.parse(e.newValue);
                }
            });
        }

        function updateUI() {
            document.getElementById('header-balance').innerText = balance.toFixed(0);
            localStorage.setItem(BALANCE_KEY, balance);
            localStorage.setItem(SHARED_KEY, JSON.stringify(inventory));
        }

        function renderCases() {
            const grid = document.getElementById('cases-grid');
            CASES.forEach(c => {
                const div = document.createElement('div');
                div.className = `glass bg-gradient-to-br ${c.color}/10 p-5 flex flex-col items-center gap-2 active:scale-95 transition-all`;
                div.onclick = () => openCaseModal(c);
                div.innerHTML = `<div class="text-4xl">üì¶</div><p class="font-bold text-sm">${c.name}</p><p class="text-xs text-blue-400 font-bold">${c.price || 'FREE'}</p>`;
                grid.appendChild(div);
            });
        }

        function openCaseModal(c) {
            if(isSpinning) return;
            activeCase = c;
            document.getElementById('modal-title').innerText = c.name;
            document.getElementById('modal-price').innerText = c.price + " ‚≠ê";
            document.getElementById('drop-list-items').innerHTML = c.loot.map(l => `
                <div class="glass p-2 flex flex-col items-center">
                    <span class="text-xl">${l.item.emoji}</span>
                </div>
            `).join('');
            document.getElementById('case-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-content').style.transform = 'translateY(0)', 10);
            document.getElementById('roulette-view').classList.add('hidden');
            document.getElementById('droplist-view').classList.remove('hidden');
            document.getElementById('open-btn').style.display = 'block';
        }

        function startOpening() {
            if (balance < activeCase.price) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!");
            isSpinning = true;
            balance -= activeCase.price;
            updateUI();

            document.getElementById('droplist-view').classList.add('hidden');
            document.getElementById('open-btn').style.display = 'none';
            document.getElementById('roulette-view').classList.remove('hidden');

            const rand = Math.random() * 100;
            let cum = 0; let winner = activeCase.loot[0].item;
            for(let l of activeCase.loot) { cum += l.chance; if(rand <= cum) { winner = l.item; break; } }

            const strip = document.getElementById('roulette-strip');
            strip.style.transition = 'none'; strip.style.transform = 'translateX(0)';
            let html = '';
            for(let i=0; i<60; i++) {
                const r = activeCase.loot[Math.floor(Math.random()*activeCase.loot.length)].item;
                html += `<div class="roulette-item"><span class="text-3xl">${r.emoji}</span></div>`;
            }
            strip.innerHTML = html;
            strip.children[55].innerHTML = `<span class="text-3xl">${winner.emoji}</span>`;

            setTimeout(() => {
                const target = (55 * 100) - (document.querySelector('.roulette-wrapper').offsetWidth / 2) + 50;
                strip.style.transition = 'transform 5s cubic-bezier(0.1, 0, 0.1, 1)';
                strip.style.transform = `translateX(-${target}px)`;
            }, 50);

            setTimeout(() => {
                if(winner.name.includes('–ó–≤–µ–∑–¥')) balance += winner.value;
                else inventory.unshift({...winner, id: Date.now()});
                updateUI();
                isSpinning = false;
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`–í—ã–ø–∞–ª–æ: ${winner.name}! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ú–∞—Ä–∫–µ—Ç–µ.`);
                closeModal();
            }, 5500);
        }

        function closeModal() {
            if(isSpinning) return;
            document.getElementById('modal-content').style.transform = 'translateY(100%)';
            setTimeout(() => document.getElementById('case-modal').classList.add('hidden'), 300);
        }

        window.onload = init;
    </script>
</body>
</html>
