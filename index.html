<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1case Web App - Visible Odds</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --tg-theme-bg-color: #0f1218;
            --accent-blue: #007aff;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: white;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 20px; }
        
        /* Snow Animation */
        .snow-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; background: white; border-radius: 50%; opacity: 0.3; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(100vh); } }

        /* Roulette Styling */
        .roulette-wrapper { position: relative; width: 100%; height: 120px; overflow: hidden; border-radius: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); }
        .roulette-container { display: flex; position: absolute; left: 0; transition: transform 5s cubic-bezier(0.15, 0, 0.15, 1); }
        .roulette-item { min-width: 100px; height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid rgba(255,255,255,0.05); }
        .roulette-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2px; height: 100%; background: var(--accent-blue); z-index: 10; box-shadow: 0 0 15px var(--accent-blue); }

        .premium-border { border: 2px solid #facc15; box-shadow: 0 0 10px rgba(250, 204, 21, 0.3); }
        .nav-active { color: var(--accent-blue); }
        .page { display: none; height: calc(100vh - 80px); overflow-y: auto; padding: 20px; padding-top: 10px; z-index: 1; position: relative; }
        .page.active { display: block; }
        ::-webkit-scrollbar { display: none; }

        /* Odds Badge */
        .odds-badge {
            background: rgba(0, 122, 255, 0.2);
            color: #70b5ff;
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 6px;
            font-weight: bold;
            border: 1px solid rgba(0, 122, 255, 0.3);
        }
    </style>
</head>
<body>

    <div class="snow-container" id="snow"></div>

    <header class="flex justify-between items-center p-4 z-10 relative">
        <div class="flex items-center gap-2 glass px-3 py-1">
            <span class="text-yellow-400 text-sm">‚≠ê</span>
            <span id="header-balance" class="font-bold text-sm">0.99</span>
        </div>
        <div id="user-avatar" class="w-8 h-8 rounded-full border border-blue-500 overflow-hidden">
            <img src="https://via.placeholder.com/32" id="pfp-img">
        </div>
    </header>

    <main>
        <section id="page-cases" class="page active">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Cases</h2>
                <span class="text-[10px] opacity-50 px-2 py-1 glass">Verifiable Odds <i data-lucide="shield-check" class="inline w-3 h-3"></i></span>
            </div>
            <div class="grid grid-cols-2 gap-4" id="cases-grid"></div>
        </section>

        <section id="page-deposit" class="page">
            <div class="flex flex-col items-center justify-center h-full text-center">
                <i data-lucide="shopping-cart" class="w-16 h-16 text-blue-500 mb-4"></i>
                <h2 class="text-xl font-bold">Market</h2>
                <p class="text-gray-400 mt-2 px-10">P2P Trading coming soon.</p>
            </div>
        </section>

        <section id="page-profile" class="page">
            <div class="glass p-6 mb-4 flex items-center gap-4">
                <img src="" id="profile-pfp" class="w-16 h-16 rounded-2xl border-2 border-blue-500">
                <div>
                    <h3 id="profile-name" class="text-xl font-bold">User</h3>
                    <p class="text-xs text-blue-400">Inventory Value: <span id="inv-value">0</span> ‚≠ê</p>
                </div>
            </div>
            <h3 class="font-bold mb-3 flex items-center gap-2 px-1">Inventory</h3>
            <div id="inventory-grid" class="grid grid-cols-3 gap-2 pb-10"></div>
        </section>
    </main>

    <div id="case-modal" class="fixed inset-0 z-50 flex items-end justify-center hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="glass w-full max-w-md p-6 rounded-t-[30px] z-10 translate-y-full transition-transform duration-300" id="modal-content">
            <div class="w-12 h-1 bg-white/20 rounded-full mx-auto mb-6"></div>
            
            <h2 id="modal-title" class="text-2xl font-bold text-center mb-1">Case</h2>
            <p id="modal-price" class="text-center text-blue-400 mb-6 font-bold text-sm">50 ‚≠ê</p>

            <div id="roulette-view" class="hidden">
                <div class="roulette-wrapper mb-6">
                    <div class="roulette-pointer"></div>
                    <div class="roulette-container" id="roulette-strip"></div>
                </div>
            </div>

            <div id="droplist-view">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[10px] opacity-50 uppercase font-bold tracking-wider">Loot Table & Odds</p>
                    <p class="text-[9px] text-green-500 font-bold">Fair Play Guaranteed</p>
                </div>
                <div class="grid grid-cols-4 gap-2 mb-8" id="drop-list-items"></div>
            </div>

            <button id="open-btn" onclick="startOpening()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-500/30 active:scale-95 transition-all">
                Open Case
            </button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 h-20 glass rounded-none border-t border-white/10 flex justify-around items-center px-4 z-20">
        <button onclick="showPage('cases')" id="nav-cases" class="flex flex-col items-center gap-1 nav-active">
            <i data-lucide="package"></i><span class="text-[10px] font-bold">CASES</span>
        </button>
        <button onclick="showPage('deposit')" id="nav-deposit" class="flex flex-col items-center gap-1 opacity-50">
            <i data-lucide="trending-up"></i><span class="text-[10px] font-bold">MARKET</span>
        </button>
        <button onclick="showPage('profile')" id="nav-profile" class="flex flex-col items-center gap-1 opacity-50">
            <i data-lucide="user"></i><span class="text-[10px] font-bold">PROFILE</span>
        </button>
    </nav>

    <script>
        const ITEMS = {
            S1: { id: 1, name: '1 Star', emoji: '‚≠ê', value: 1, rarity: 'common' },
            S5: { id: 2, name: '5 Stars', emoji: '‚≠ê', value: 5, rarity: 'common' },
            BEAR: { id: 3, name: 'Bear', emoji: 'üß∏', value: 15, rarity: 'rare' },
            CAKE: { id: 4, name: 'Cake', emoji: 'üéÇ', value: 50, rarity: 'legendary' },
            ROCKET: { id: 5, name: 'Rocket', emoji: 'üöÄ', value: 100, rarity: 'legendary' },
            CANDLE: { id: 6, name: 'B-day Candle', emoji: 'üïØÔ∏è', value: 500, rarity: 'nft', nft: true },
            GOLD_MONKEY: { id: 7, name: 'Gold Monkey', emoji: 'üêí', value: 800, rarity: 'nft', nft: true }
        };

        const CASES = [
            { id: 'free', name: 'Free', price: 0, color: 'from-green-500', loot: [
                { item: ITEMS.S1, chance: 80 }, { item: ITEMS.BEAR, chance: 15 }, { item: ITEMS.CAKE, chance: 5 }
            ]},
            { id: 'bum', name: 'Bum', price: 25, color: 'from-orange-500', loot: [
                { item: ITEMS.S5, chance: 70 }, { item: ITEMS.BEAR, chance: 25 }, { item: ITEMS.CAKE, chance: 5 }
            ]},
            { id: 'normal', name: 'Normal', price: 50, color: 'from-blue-500', loot: [
                { item: ITEMS.BEAR, chance: 60 }, { item: ITEMS.CAKE, chance: 30 }, { item: ITEMS.ROCKET, chance: 10 }
            ]},
            { id: 'rocket', name: 'Rocket', price: 100, color: 'from-purple-500', loot: [
                { item: ITEMS.CAKE, chance: 70 }, { item: ITEMS.ROCKET, chance: 29.9 }, { item: ITEMS.CANDLE, chance: 0.1 }
            ]},
            { id: 'world', name: 'World', price: 500, color: 'from-yellow-500', loot: [
                { item: ITEMS.CANDLE, chance: 95 }, { item: ITEMS.GOLD_MONKEY, chance: 5 }
            ]}
        ];

        let balance = parseFloat(localStorage.getItem('balance')) || 100.00;
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let activeCase = null;
        let isSpinning = false;
        const tg = window.Telegram.WebApp;

        function init() {
            lucide.createIcons();
            createSnow();
            renderCases();
            updateUI();
            if (tg.initDataUnsafe?.user) {
                const u = tg.initDataUnsafe.user;
                document.getElementById('profile-name').innerText = u.first_name;
                if(u.photo_url) document.querySelectorAll('[id*="pfp"]').forEach(el => el.src = u.photo_url);
            }
            tg.expand();
        }

        function createSnow() {
            const container = document.getElementById('snow');
            for(let i=0; i<30; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.style.left = Math.random() * 100 + 'vw';
                flake.style.width = flake.style.height = Math.random() * 3 + 2 + 'px';
                flake.style.animationDuration = Math.random() * 3 + 4 + 's';
                container.appendChild(flake);
            }
        }

        function renderCases() {
            const grid = document.getElementById('cases-grid');
            CASES.forEach(c => {
                const card = document.createElement('div');
                card.className = `glass bg-gradient-to-br ${c.color}/10 p-5 flex flex-col items-center gap-3 active:scale-95 transition-transform cursor-pointer`;
                card.onclick = () => openCaseModal(c);
                card.innerHTML = `<div class="text-3xl">üì¶</div><div class="text-center"><p class="font-bold text-sm">${c.name}</p><p class="text-[10px] text-blue-400 font-bold">${c.price === 0 ? 'CLAIM' : c.price + ' ‚≠ê'}</p></div>`;
                grid.appendChild(card);
            });
        }

        function openCaseModal(c) {
            activeCase = c;
            document.getElementById('modal-title').innerText = c.name;
            document.getElementById('modal-price').innerText = c.price === 0 ? "Daily Free" : `${c.price} ‚≠ê`;
            
            const dropList = document.getElementById('drop-list-items');
            dropList.innerHTML = '';
            c.loot.forEach(l => {
                const div = document.createElement('div');
                div.className = "flex flex-col items-center glass p-2 gap-1 relative overflow-hidden";
                div.innerHTML = `
                    <span class="odds-badge">${l.chance}%</span>
                    <span class="text-xl">${l.item.emoji}</span>
                    <span class="text-[8px] opacity-50 truncate w-full text-center">${l.item.name}</span>
                `;
                dropList.appendChild(div);
            });

            const modal = document.getElementById('case-modal');
            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('modal-content').style.transform = 'translateY(0)', 10);
            document.getElementById('roulette-view').classList.add('hidden');
            document.getElementById('droplist-view').classList.remove('hidden');
            document.getElementById('open-btn').style.display = 'block';
        }

        function startOpening() {
            if (balance < activeCase.price) return tg.showAlert("Insufficient Stars");
            isSpinning = true;
            balance -= activeCase.price;
            updateUI();
            tg.HapticFeedback.impactOccurred('medium');

            document.getElementById('droplist-view').classList.add('hidden');
            document.getElementById('open-btn').style.display = 'none';
            document.getElementById('roulette-view').classList.remove('hidden');

            const strip = document.getElementById('roulette-strip');
            strip.style.transition = 'none';
            strip.style.transform = 'translateX(0)';

            // Weighted Random Selection
            const rand = Math.random() * 100;
            let cumulative = 0;
            let winnerItem = activeCase.loot[0].item;
            for(let l of activeCase.loot) {
                cumulative += l.chance;
                if(rand <= cumulative) { winnerItem = l.item; break; }
            }

            // Fill Strip
            let stripHTML = '';
            for(let i=0; i<60; i++) {
                const randomLoot = activeCase.loot[Math.floor(Math.random() * activeCase.loot.length)].item;
                stripHTML += `<div class="roulette-item"><span class="text-3xl">${randomLoot.emoji}</span></div>`;
            }
            strip.innerHTML = stripHTML;
            
            const winningIndex = 55;
            strip.children[winningIndex].innerHTML = `<span class="text-3xl">${winnerItem.emoji}</span>`;
            if(winnerItem.nft) strip.children[winningIndex].classList.add('premium-border');

            setTimeout(() => {
                const itemWidth = 100;
                const center = document.querySelector('.roulette-wrapper').offsetWidth / 2;
                const targetX = (winningIndex * itemWidth) - center + (itemWidth / 2);
                strip.style.transition = 'transform 5s cubic-bezier(0.1, 0, 0.1, 1)';
                strip.style.transform = `translateX(-${targetX}px)`;
            }, 50);

            setTimeout(() => {
                inventory.unshift(winnerItem);
                if(winnerItem.value && winnerItem.name.includes('Star')) balance += winnerItem.value;
                updateUI();
                isSpinning = false;
                tg.HapticFeedback.notificationOccurred('success');
                tg.showConfirm(`Won: ${winnerItem.name}`, () => closeModal());
            }, 5500);
        }

        function updateUI() {
            document.getElementById('header-balance').innerText = balance.toFixed(2);
            document.getElementById('inv-value').innerText = inventory.reduce((acc, curr) => acc + curr.value, 0);
            const invGrid = document.getElementById('inventory-grid');
            invGrid.innerHTML = '';
            inventory.forEach(item => {
                const d = document.createElement('div');
                d.className = `glass p-2 flex flex-col items-center aspect-square justify-center ${item.nft ? 'premium-border' : ''}`;
                d.innerHTML = `<span class="text-2xl">${item.emoji}</span><span class="text-[8px] opacity-60 mt-1">${item.name}</span>`;
                invGrid.appendChild(d);
            });
            localStorage.setItem('balance', balance);
            localStorage.setItem('inventory', JSON.stringify(inventory));
        }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.add('opacity-50'));
            document.getElementById(`nav-${p}`).classList.remove('opacity-50');
            tg.HapticFeedback.impactOccurred('light');
        }

        function closeModal() { if(!isSpinning) { document.getElementById('modal-content').style.transform = 'translateY(100%)'; setTimeout(() => document.getElementById('case-modal').classList.add('hidden'), 300); } }

        window.onload = init;
    </script>
</body>
</html>
