<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Case Opening</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [–í–µ—Å—å CSS-–∫–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ] */
        /* ... (–≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –ø–æ–ª–Ω—ã–π CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞) ... */
    </style>
</head>
<body>
    <!-- [–í–µ—Å—å HTML-–∫–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô] -->
    <!-- ... (–≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –ø–æ–ª–Ω—ã–π HTML –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞) ... -->

    <script>
        // ========== –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ß–ê–°–¢–¨: –£–°–¢–†–ê–ù–ï–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–ê –ò–ú–Å–ù ==========
        
        // Telegram Web App initialization
        const tg = window.Telegram?.WebApp || {
            expand: () => console.log('App expanded'),
            ready: () => console.log('App ready'),
            initDataUnsafe: { user: null },
            showAlert: (msg) => { alert(msg); return Promise.resolve(true); }
        };
        
        tg.expand();
        tg.ready();
        
        // User data
        const user = tg.initDataUnsafe?.user || {
            id: 123456789,
            username: 'telegram_user',
            first_name: 'Telegram',
            last_name: 'User'
        };
        
        // State
        let userBalance = 150;
        let openedCases = 0;
        let totalStarsWon = 0;
        let nftCount = 0;
        let lastWins = [];
        let currentCaseType = null;
        let isSpinning = false;
        
        // Cases data
        const casesData = {
            free: {
                name: "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å",
                price: 0,
                items: [
                    { type: "star", icon: "‚≠ê", name: "1 –∑–≤–µ–∑–¥–∞", price: 1, chance: 90 },
                    { type: "gift", icon: "üß∏", name: "–ú–∏—à–∫–∞", price: 15, chance: 7 },
                    { type: "gift", icon: "üéÇ", name: "–¢–æ—Ä—Ç–∏–∫", price: 50, chance: 3 }
                ]
            },
            bumzh: {
                name: "–ë–æ–º–∂ –∫–µ–π—Å",
                price: 25,
                items: [
                    { type: "star", icon: "‚≠ê", name: "5 –∑–≤–µ–∑–¥", price: 5, chance: 60 },
                    { type: "gift", icon: "üß∏", name: "–ú–∏—à–∫–∞", price: 15, chance: 10 },
                    { type: "gift", icon: "üéÇ", name: "–¢–æ—Ä—Ç–∏–∫", price: 50, chance: 9 },
                    { type: "star", icon: "‚≠ê", name: "25 –∑–≤–µ–∑–¥", price: 25, chance: 1 }
                ]
            },
            normal: {
                name: "–ù–æ—Ä–º–∞–ª–∏–∫",
                price: 50,
                items: [
                    { type: "gift", icon: "üß∏", name: "–ú–∏—à–∫–∞", price: 15, chance: 50 },
                    { type: "gift", icon: "üéÇ", name: "–¢–æ—Ä—Ç–∏–∫", price: 50, chance: 35 },
                    { type: "gift", icon: "üöÄ", name: "–†–∞–∫–µ—Ç–∞", price: 100, chance: 14.9 },
                    { type: "nft", icon: "üñº", name: "NFT B-day Candle", price: 300, chance: 0.1 }
                ]
            },
            rocket: {
                name: "–†–∞–∫–µ—Ç–∫–∞",
                price: 100,
                items: [
                    { type: "gift", icon: "üéÇ", name: "–¢–æ—Ä—Ç–∏–∫", price: 50, chance: 50 },
                    { type: "gift", icon: "üöÄ", name: "–†–∞–∫–µ—Ç–∞", price: 100, chance: 44.9 },
                    { type: "nft", icon: "üñº", name: "NFT B-day Candle", price: 300, chance: 5 }
                ]
            },
            world: {
                name: "–ú–∏—Ä",
                price: 500,
                items: [
                    { type: "nft", icon: "üñº", name: "NFT Moon", price: 300, chance: 40 },
                    { type: "nft", icon: "üñº", name: "NFT Star", price: 400, chance: 30 },
                    { type: "nft", icon: "üñº", name: "NFT Galaxy", price: 500, chance: 20 },
                    { type: "nft", icon: "üñº", name: "NFT Universe", price: 600, chance: 8 },
                    { type: "nft", icon: "üñº", name: "NFT Infinity", price: 800, chance: 2 }
                ]
            }
        };
        
        // DOM Elements - –í–ê–ñ–ù–û: –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
        const balanceElement = document.getElementById('balance');
        const userNameElement = document.getElementById('user-name');
        const userAvatarElement = document.getElementById('user-avatar');
        const dropModal = document.getElementById('drop-modal');
        const openModal = document.getElementById('open-modal');
        const dropContent = document.getElementById('drop-content');
        const itemsWheel = document.getElementById('items-wheel');
        const spinBtn = document.getElementById('spin-btn');
        const resultContent = document.getElementById('result-content');
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
        const closeDropModalFunc = () => {
            dropModal.classList.remove('active');
        };
        
        const closeOpenModalFunc = () => {
            openModal.classList.remove('active');
            isSpinning = false;
            currentCaseType = null;
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function initApp() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            userNameElement.textContent = user.username || `${user.first_name || ''} ${user.last_name || ''}`.trim() || `User ${user.id}`;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
            const savedBalance = localStorage.getItem('caseBalance');
            if (savedBalance) userBalance = parseInt(savedBalance);
            balanceElement.textContent = userBalance;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
            document.addEventListener('click', (e) => {
                const target = e.target;
                
                // –ö–Ω–æ–ø–∫–∏ "–ß—Ç–æ –≤—ã–ø–∞–¥–∞–µ—Ç"
                if (target.classList.contains('view-drop-btn')) {
                    const caseType = target.dataset.case;
                    showDropModal(caseType);
                }
                
                // –ö–Ω–æ–ø–∫–∏ "–û—Ç–∫—Ä—ã—Ç—å"
                if (target.classList.contains('open-btn')) {
                    const caseType = target.dataset.case;
                    showOpenModal(caseType);
                }
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                if (target.id === 'close-drop-modal' || target.closest('#close-drop-modal')) {
                    closeDropModalFunc();
                }
                
                if (target.id === 'close-open-modal' || target.closest('#close-open-modal')) {
                    closeOpenModalFunc();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ö—Ä—É—Ç–∏—Ç—å!"
            spinBtn.addEventListener('click', spinWheel);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
            dropModal.addEventListener('click', (e) => {
                if (e.target === dropModal) closeDropModalFunc();
            });
            
            openModal.addEventListener('click', (e) => {
                if (e.target === openModal) closeOpenModalFunc();
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDropModalFunc();
                    closeOpenModalFunc();
                }
            });
            
            console.log('App initialized successfully');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ —Å –¥—Ä–æ–ø–æ–º
        function showDropModal(caseType) {
            const caseData = casesData[caseType];
            let itemsHTML = '';
            
            caseData.items.forEach(item => {
                itemsHTML += `
                    <div class="item-card">
                        <div class="item-icon">${item.icon}</div>
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">${item.price} ‚≠ê</div>
                        <div class="item-chance">${item.chance}%</div>
                    </div>
                `;
            });
            
            dropContent.innerHTML = `
                <h3 style="margin-bottom: 15px; color: var(--tg-theme-link-color);">${caseData.name}</h3>
                <p style="margin-bottom: 20px; opacity: 0.8;">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞:</p>
                <div class="items-grid">
                    ${itemsHTML}
                </div>
            `;
            dropModal.classList.add('active');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
        function showOpenModal(caseType) {
            const caseData = casesData[caseType];
            currentCaseType = caseType;
            
            if (userBalance < caseData.price && caseType !== 'free') {
                alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥! –ù—É–∂–Ω–æ: ${caseData.price} ‚≠ê`);
                return;
            }
            
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–ª–µ—Å–∞
            itemsWheel.innerHTML = '';
            for (let i = 0; i < 30; i++) {
                const item = caseData.items[Math.floor(Math.random() * caseData.items.length)];
                itemsWheel.innerHTML += `
                    <div class="wheel-item">
                        <div style="font-size: 48px;">${item.icon}</div>
                        <div style="font-size: 12px; margin-top: 10px;">${item.name}</div>
                    </div>
                `;
            }
            
            resultContent.style.display = 'none';
            itemsWheel.style.display = 'flex';
            spinBtn.style.display = 'block';
            spinBtn.disabled = false;
            
            if (caseType !== 'free') {
                userBalance -= caseData.price;
                balanceElement.textContent = userBalance;
                localStorage.setItem('caseBalance', userBalance.toString());
            }
            
            openModal.classList.add('active');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–ª–µ—Å–∞
        function spinWheel() {
            if (isSpinning || !currentCaseType) return;
            
            isSpinning = true;
            spinBtn.disabled = true;
            spinBtn.textContent = '–ö—Ä—É—Ç–∏—Ç—Å—è...';
            
            const caseData = casesData[currentCaseType];
            const items = caseData.items;
            const totalWeight = items.reduce((sum, item) => sum + item.chance, 0);
            let random = Math.random() * totalWeight;
            let selectedItem = items[0];
            
            for (const item of items) {
                random -= item.chance;
                if (random <= 0) {
                    selectedItem = item;
                    break;
                }
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è
            const wheel = itemsWheel;
            const itemWidth = 122;
            const spinDuration = 3000;
            const startTime = Date.now();
            const selectedIndex = Math.floor(Math.random() * 15) + 10;
            const targetPosition = -(selectedIndex * itemWidth);
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / spinDuration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentPosition = targetPosition * easeOut;
                
                wheel.style.transform = `translateX(${currentPosition}px)`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    setTimeout(() => {
                        showResult(selectedItem);
                    }, 500);
                }
            }
            
            requestAnimationFrame(animate);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        function showResult(item) {
            itemsWheel.style.display = 'none';
            spinBtn.style.display = 'none';
            
            userBalance += item.price;
            totalStarsWon += item.price;
            if (item.type === 'nft') nftCount++;
            
            balanceElement.textContent = userBalance;
            localStorage.setItem('caseBalance', userBalance.toString());
            
            lastWins.push({
                icon: item.icon,
                name: item.name,
                price: item.price,
                timestamp: Date.now()
            });
            
            if (lastWins.length > 10) lastWins = lastWins.slice(-10);
            localStorage.setItem('lastWins', JSON.stringify(lastWins));
            
            resultContent.style.display = 'block';
            resultContent.innerHTML = `
                <div class="result-card">
                    <div class="result-icon">${item.icon}</div>
                    <div class="result-name">${item.name}</div>
                    <div class="result-price">+${item.price} ‚≠ê</div>
                    <p style="margin-top: 20px; opacity: 0.8;">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</p>
                    <button class="case-button" onclick="closeOpenModalFunc()" style="margin-top: 20px; background: var(--tg-theme-button-color);">
                        –û—Ç–ª–∏—á–Ω–æ!
                    </button>
                </div>
            `;
            
            isSpinning = false;
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', initApp);
        
        // –î–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ HTML)
        window.closeOpenModalFunc = closeOpenModalFunc;
        window.closeDropModalFunc = closeDropModalFunc;
    </script>
</body>
</html>
